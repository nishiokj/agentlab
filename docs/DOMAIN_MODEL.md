# Domain Model: Exhaustive Inventory

Every primitive, concept, mode, enum, and primary type across all surfaces (JSON schemas, Rust structs, CLI commands, SDK types).

Items marked with **ISSUE** have a design problem identified during review. Section 12 collects all issues. Section 13 records design decisions made during review.

---

## 1. Identity Primitives

These are the atomic identifiers that thread through every layer.

| Primitive | Type | Where defined | Where consumed |
|-----------|------|---------------|----------------|
| `experiment_id` | string | `resolved_experiment_v0_3.experiment.id`, `ExperimentSpec.experiment.id` (SDK) | **ISSUE**: Rust calls it `exp_id`, CLI JSON calls it `"experiment"`, `build_trial_input()` puts experiment_id into `ids.run_id` (bug) |
| `experiment_name` | string | `resolved_experiment_v0_3.experiment.name`, SDK builder | Display only |
| `run_id` | string | Generated by runner (`run_YYYYMMDD_HHMMSS`) | `ids.run_id` in trial_input, trial_output, events, benchmarks, manifest_v1 |
| `trial_id` | string | Generated by runner (`t_NNNN`) | `ids.trial_id` everywhere |
| `variant_id` | string | `baseline.variant_id`, `variant_plan[].variant_id` | `ids.variant_id` everywhere |
| `task_id` | string | From dataset JSONL rows | `ids.task_id` everywhere |
| `repl_idx` | integer (0-based) | Generated by runner from `design.repeats` | `ids.repl_idx` everywhere. **ISSUE**: Currently called `replications` — see §13 |
| `adapter_id` | string | `benchmark_adapter_manifest_v1`, `workload_adapter_manifest_v1` | `benchmark.adapter_id` in prediction/score records |
| `turn_id` | string | Hook events (model/tool turn events) | Event correlation. **ISSUE**: Currently called `call_id` — see §13 |
| `trace_id` | string | `event_envelope_v1.trace.trace_id` | Distributed tracing |
| `span_id` | string | `event_envelope_v1.trace.span_id` | Distributed tracing |
| `suite_id` | string | `ExperimentSpec.dataset.suite_id` (SDK) | Dataset grouping |
| `split_id` | string | `ExperimentSpec.dataset.split_id` (SDK), `benchmark.split` in records | Dataset/benchmark split |

### The `ids` object (shared shape)

Appears identically in: `trial_input_v1`, `trial_output_v1`, `event_envelope_v1`, `hook_events_v1` (base_event), `benchmark_prediction_record_v1`, `benchmark_score_record_v1`

```
ids: {
  run_id: string
  trial_id: string
  variant_id: string
  task_id: string
  repl_idx: integer (>= 0)
}
```

---

## 2. Core Concepts

### Runner
The orchestrator that drives experiments. Rust binary `lab-cli`, core logic in `lab-runner`. Referenced as `manifest_v1.runner_version`, SDK class `LabClient`. **ISSUE**: Not named as a first-class primitive anywhere in schemas. The CLI is called `lab`, the concept is "runner".

### Experiment
A complete experimental design: dataset + parameters + variants + runtime config. Defined by `resolved_experiment_v0_3` schema (loose — `additionalProperties: true`). Built via `ExperimentBuilder` SDK class.

### Run
One execution of an experiment. Produces a run directory with artifacts. Identified by `run_id`. A run contains trials.

### Trial
One execution of one task under one variant at one replication index. The atomic unit of work. `trial_id = f(variant_id, task_id, repl_idx)`. Runner writes `trial_input.json`, harness writes `trial_output.json`.

### Variant
A set of parameter assignments that define an experimental condition. One variant is the `baseline`; others are in `variant_plan[]`. **ISSUE**: Currently `bindings` is an opaque `Record<string, unknown>` with no connection to the parameter manifest — see §13.

### Parameter (currently "Knob")
A named, typed, validated experimental variable. Has an id, type, range, and scientific role. Defined in a parameter manifest. **ISSUE**: Currently called "knob" everywhere — see §13.

### Task
A single item from the dataset. Each task is run under every variant × every repeat.

### Harness
The user-provided program that executes a trial. Consumes `trial_input.json`, produces `trial_output.json`. Declares its capabilities via `harness_manifest_v1`.

### Step
A discrete phase within a trial execution. Tracked by `step_index`. Events `agent_step_start` / `agent_step_end` bracket steps.

### Turn
One iteration of the agent loop (think → act → observe) within a step. Tracked by `turn_index`. Contains model responses and tool results as sub-events. **ISSUE**: Currently called "call" in event names — see §13.

### Repeat (currently "Replication")
How many times each (variant, task) pair is executed. Indexed by `repl_idx`. **ISSUE**: Currently called `replications` which collides with runs/trials — see §13.

---

## 3. Top-Level Entities (Schemas)

17 schemas total.

| Schema | `schema_version` const | Purpose |
|--------|----------------------|---------|
| `resolved_experiment_v0_3` | `"0.3"` (uses `version` not `schema_version`) | Experiment definition (loose — `additionalProperties: true`) |
| `trial_input_v1` | `"trial_input_v1"` | Runner → Harness contract per trial |
| `trial_output_v1` | `"trial_output_v1"` | Harness → Runner result per trial |
| `harness_manifest_v1` | `"harness_manifest_v1"` | Harness self-declaration of capabilities |
| `hook_events_v1` | `"hook_events_v1"` | Per-line JSONL event stream from harness |
| `event_envelope_v1` | envelope_version `"1"`, schema_version `"0.3"` | Normalized event envelope (runner-produced) |
| `grades_v1` | `"grades_v1"` | Quality grades for a run |
| `attestation_v1` | `"attestation_v1"` | Provenance attestation for a run |
| `state_inventory_v1` | `"state_inventory_v1"` | Pre/post-trial state snapshot |
| `manifest_v1` | `"manifest_v1"` | Run-level manifest (runner version, git, tools) |
| `knob_manifest_v1` | `"knob_manifest_v1"` | Parameter definitions. **ISSUE**: Rename to `parameter_manifest_v1` |
| `experiment_overrides_v1` | `"experiment_overrides_v1"` | User overrides to experiment parameters |
| `trace_manifest_v1` | `"trace_manifest_v1"` | Trace file manifest |
| `benchmark_adapter_manifest_v1` | `"benchmark_adapter_manifest_v1"` | Benchmark adapter definition |
| `benchmark_prediction_record_v1` | `"benchmark_prediction_record_v1"` | Per-trial benchmark prediction |
| `benchmark_score_record_v1` | `"benchmark_score_record_v1"` | Per-trial benchmark score/verdict |
| `workload_adapter_manifest_v1` | `"workload_adapter_manifest_v1"` | Workload adapter definition |

---

## 4. All Enums (with every value)

### 4a. Core Mode Enums

**Integration Level** — genuinely multi-valued spectrum
- Values: `cli_basic`, `cli_events`, `otel`, `sdk_control`, `sdk_full`
- Appears in: `grades_v1`, `harness_manifest_v1`, `state_inventory_v1`, `trial_input_v1.design`, `ExperimentSpec.runtime.harness`, `HarnessCliOptions` (SDK), `ExperimentSummary` (Rust + SDK)

**Network Mode** — tri-state
- Values: `none`, `full`, `allowlist_enforced`
- Appears in: `trial_input_v1.runtime.network.mode_requested`, `state_inventory_v1.network.mode_requested`, `state_inventory_v1.network.mode_effective`, `ExperimentSpec.runtime.network.mode` (SDK)
- **ISSUE**: Rust struct calls it `network_mode`, CLI JSON calls it `"network"`, SDK type calls it `network`

**Sandbox Mode** — **ISSUE: derivable, should be eliminated**
- Values: `container`, `local`
- Currently in: `ExperimentSpec.runtime.sandbox.mode` (SDK builder), `container_mode: bool` (Rust/CLI/SDK)
- **Decision**: Image presence determines mode. If `image` is set → container. If absent → local. No separate mode field needed.

**Control Plane Mode** — binary
- Values: `file`, `uds`
- Appears in: `harness_manifest_v1.control_plane.mode`, `trial_input_v1.runtime.control_plane.mode`, `ExperimentSpec.runtime.harness.control_plane.mode` (SDK)

**Tracing Mode** — genuinely multi-valued
- Values in `harness_manifest_v1`: `none`, `otlp`, `manifest`
- Values in `attestation_v1`: `none`, `hooks`, `otlp`, `manifest`
- **ISSUE**: `hooks` missing from harness_manifest enum but present in attestation
- Appears in: `ExperimentSummary.tracing_mode` (Rust), `ExperimentSummary.tracing` (CLI JSON / SDK)

**Workload Type**
- Values: `agent_harness`, `trainer`, `custom`
- Appears in: `trial_input_v1.workload.type`, `workload_adapter_manifest_v1.workload_type`, `ExperimentSummary.workload_type`, CLI `--workload-type` flag

**Sanitization Profile**
- Values: `replay_strict_v2`, `hermetic_functional_v2`, `perf_benchmark_v2`
- Appears in: `trial_input_v1.design.sanitization_profile`, `state_inventory_v1.sanitization_profile`, `ExperimentSpec.design.sanitization_profile` (SDK)

**Execution Mode** (adapters)
- Benchmark adapter values: `predict_then_score`, `integrated_score`
- Workload adapter values: `cli`, `sdk`
- **ISSUE**: Same field name, different enum values between `benchmark_adapter_manifest_v1.execution_mode` and `workload_adapter_manifest_v1.execution.mode`

**Harness Mode** — single value
- Values: `cli`
- Appears in: `ExperimentSpec.runtime.harness.mode` (SDK builder only)
- **ISSUE**: Enum with one value. Could be a constant or removed.

### 4b. Outcome / Verdict / Status Enums

These are intentionally different at different layers:

**Trial Outcome** — trial-level result
- Values: `success`, `failure`, `missing`, `error`
- Appears in: `trial_output_v1.outcome`

**Benchmark Verdict** — benchmark scoring result
- Values: `pass`, `fail`, `missing`, `error`
- Appears in: `benchmark_score_record_v1.verdict`

**Event Outcome Status** — per-event result
- Values: `ok`, `error`, `missing`
- Appears in: `event_envelope_v1.outcome.status`

**Hook Event Outcome Status** — per-hook-event result
- Values: `ok`, `error`
- Appears in: `hook_events_v1` → `model_call_end.outcome.status`, `tool_call_end.outcome.status`

**Egress Test Expected/Observed**
- Expected: `allow`, `block`
- Observed: `allow`, `block`, `error`, `unknown`
- Appears in: `state_inventory_v1.network.egress_self_test.cases[]`

### 4c. Grade Enums

All in `grades_v1` schema:

- **Replay Grade**: `strict`, `checkpointed`, `best_effort`, `none`
- **Isolation Grade**: `hermetic`, `bounded`, `leaky`
- **Comparability Grade**: `valid_paired`, `valid_unpaired`, `invalid`, `unknown`
- **Provenance Grade**: `attested`, `recorded`, `partial`
- **Privacy Grade**: `redacted`, `raw`, `unknown`

### 4d. Redaction Enums

**Redaction Content Policy**
- Values: `store`, `hash`, `drop`
- Appears in: `event_envelope_v1.redaction.mode`, `hook_events_v1.base_event.redaction.mode`, `trace_manifest_v1.redaction.mode`, `harness_manifest_v1.redaction.content_policy`

**Redaction Toggle** (harness manifest only)
- Values: `on`, `off`
- Appears in: `harness_manifest_v1.redaction.mode`
- **ISSUE**: Overloaded — `redaction.mode` means content policy everywhere else but on/off toggle here

### 4e. Other Enums

| Enum | Values | Where |
|------|--------|-------|
| Comparison Design | `paired`, `unpaired` | `ExperimentSpec.design.comparison` (SDK) |
| Objective Direction | `maximize`, `minimize` | `trial_output_v1.objective.direction`, `workload_adapter_manifest_v1.default_objective.direction` |
| Prediction Kind | `patch`, `text`, `json`, `artifact_ref` | `benchmark_prediction_record_v1.prediction.kind` |
| Evaluator Mode | `official`, `custom` | `benchmark_adapter_manifest_v1.evaluator.mode`, `benchmark_score_record_v1.evaluator.mode` |
| Control Actions | `continue`, `stop`, `checkpoint` | `hook_events_v1.control_ack.action_observed`, `control_ack.action_taken` |
| Network Enforcement | `docker_none`, `netns_iptables`, `sidecar_proxy`, `unknown` | `state_inventory_v1.network.enforcement_effective` |
| Parameter Type | `string`, `integer`, `number`, `boolean`, `array`, `object` | `knob_manifest_v1.knobs[].type` |
| Parameter Role | `core`, `harness`, `benchmark`, `safety`, `analysis`, `infra` | `knob_manifest_v1.knobs[].role` |
| Parameter Scientific Role | `treatment`, `control`, `confound`, `derived`, `invariant` | `knob_manifest_v1.knobs[].scientific_role` |
| Sandbox Engine | `docker` | `ExperimentSpec.runtime.sandbox.engine` (SDK only) |

---

## 5. Rust Structs (17 structs, 1 enum)

### lab-runner (9 structs)

**`ExperimentSummary`** — `rust/crates/lab-runner/src/lib.rs:87`
```
exp_id: String                          # ISSUE: → experiment_id
workload_type: String
dataset_path: PathBuf
task_count: usize
replications: usize                     # ISSUE: → repeats
variant_count: usize
total_trials: usize
harness_command: Vec<String>
integration_level: String
container_mode: bool                    # ISSUE: eliminate — derive from image
image: Option<String>
network_mode: String
events_path: Option<String>
tracing_mode: Option<String>
control_path: String
harness_script_resolved: Option<PathBuf>
harness_script_exists: bool             # ISSUE: redundant — derivable from harness_script_resolved
```

**`RunResult`** — `rust/crates/lab-runner/src/lib.rs:19`
```
run_dir: PathBuf
run_id: String
```

**`RunBehavior`** — `rust/crates/lab-runner/src/lib.rs:69`
```
setup_command: Option<String>
network_mode_override: Option<String>
require_network_none: bool
```

**`ExperimentOverrides`** — `rust/crates/lab-runner/src/lib.rs:24`
```
schema_version: String
manifest_path: Option<String>
values: BTreeMap<String, Value>
```

**`KnobManifest`** — `rust/crates/lab-runner/src/lib.rs:33` — **ISSUE: rename to `ParameterManifest`**
```
schema_version: String
knobs: Vec<KnobDef>                     # ISSUE: → parameters: Vec<ParameterDef>
```

**`KnobDef`** — `rust/crates/lab-runner/src/lib.rs:39` — **ISSUE: rename to `ParameterDef`**
```
id: String
json_pointer: String
value_type: String (serde renamed from "type")
options: Option<Vec<Value>>
minimum: Option<f64>
maximum: Option<f64>
```

**`Variant`** — `rust/crates/lab-runner/src/lib.rs:583`
```
id: String
bindings: Value                         # ISSUE: should be validated against parameter manifest
```

**`HarnessConfig`** — `rust/crates/lab-runner/src/lib.rs:918`
```
command_raw: Vec<String>
integration_level: String
input_path: String
output_path: String
events_path: Option<String>
control_path: String
tracing_mode: Option<String>
force_container: bool                   # ISSUE: eliminate — derive from image
```

**`TrialPaths`** — `rust/crates/lab-runner/src/lib.rs:988`
```
trial_dir: PathBuf
workspace: PathBuf
state: PathBuf
dataset: PathBuf
out: PathBuf
tmp: PathBuf
dataset_src: PathBuf
exp_dir: PathBuf
```

### lab-cli (1 struct, 1 enum)

**`Cli`** — `rust/crates/lab-cli/src/main.rs:6`
```
command: Commands
```

**`Commands`** (enum) — `rust/crates/lab-cli/src/main.rs:13`
Variants:
- `Run { experiment, container, overrides, json }`            — **ISSUE**: `container` flag → `--image`
- `RunDev { experiment, setup, overrides, json }`
- `RunExperiment { experiment, overrides, json }`
- `Describe { experiment, overrides, json }`
- `KnobsInit { manifest, overrides, force }`                 — **ISSUE**: rename knobs → params
- `KnobsValidate { manifest, overrides, json }`              — **ISSUE**: rename knobs → params
- `SchemaValidate { schema, file, json }`
- `HooksValidate { manifest, events, json }`
- `Publish { run_dir, out, json }`
- `Init { in_place, force }`
- `Clean { init, runs }`

### lab-hooks (4 structs)

**`HarnessManifest`** — `rust/crates/lab-hooks/src/lib.rs:9`
```
schema_version: String
integration_level: String
step: Option<ManifestStep>
hooks: Option<ManifestHooks>
```

**`ManifestStep`** — `rust/crates/lab-hooks/src/lib.rs:17`
```
semantics: String
```

**`ManifestHooks`** — `rust/crates/lab-hooks/src/lib.rs:22`
```
schema_version: String
events_path: String
header_event_emitted: Option<bool>
```

**`HookValidationError`** — `rust/crates/lab-hooks/src/lib.rs:29`
```
message: String
line: Option<usize>
seq: Option<i64>
event_type: Option<String>
```

### lab-otel (2 structs)

**`TraceIngestRecord`** — `rust/crates/lab-otel/src/lib.rs:10`
```
timestamp: String
content_type: Option<String>
artifact_ref: String
size_bytes: usize
```

**`OtlpReceiver`** — `rust/crates/lab-otel/src/lib.rs:18`
```
endpoint: String
server_thread: Option<JoinHandle<()>>
records: Arc<Mutex<Vec<TraceIngestRecord>>>
```

### lab-core (1 struct)

**`ArtifactStore`** — `rust/crates/lab-core/src/lib.rs:60`
```
root: PathBuf
```

### lab-provenance, lab-analysis, lab-schemas

No struct/enum definitions. Functions only.

---

## 6. SDK Types (3 type aliases, 23 interfaces, 3 classes)

### Type Aliases

| Name | Definition | File:Line |
|------|-----------|-----------|
| `JsonMap` | `Record<string, unknown>` | `types.ts:1` |
| `JsonCommandResponse` | Union of all response types | `types.ts:80` |
| `Bindings` | `Record<string, unknown>` | `experiment-builder.ts:3` — **ISSUE**: should be validated against parameter manifest |

### Interfaces — Response Envelopes

**`LabErrorPayload`** — `types.ts:3`
```ts
code: string
message: string
details?: unknown
```

**`LabErrorEnvelope`** — `types.ts:9`
```ts
ok: false
error: LabErrorPayload
```

**`DescribeResponse`** — `types.ts:39`
```ts
ok: true
command: 'describe'
summary: ExperimentSummary
```

**`RunResponse`** — `types.ts:45`
```ts
ok: true
command: 'run' | 'run-dev' | 'run-experiment'
summary: ExperimentSummary
run: RunResult
container?: boolean                      # ISSUE: redundant
dev_setup?: string | null                # ISSUE: redundant with summary
dev_network_mode?: string                # ISSUE: redundant with summary
experiment_network_requirement?: string  # ISSUE: redundant with summary
```

**`PublishResponse`** — `types.ts:57`
```ts
ok: true
command: 'publish'
bundle: string
run_dir: string
```

**`ValidateResponse`** — `types.ts:64`
```ts
ok: true
command: 'knobs-validate' | 'schema-validate' | 'hooks-validate'  # ISSUE: knobs → params
valid: true
[key: string]: unknown
```

### Interfaces — Domain Objects

**`ExperimentSummary`** — `types.ts:14`
```ts
experiment: string                       # ISSUE: → experiment_id
workload_type: string
dataset: string                          # ISSUE: → dataset_path
tasks: number                            # ISSUE: → task_count
replications: number                     # ISSUE: → repeats
variant_plan_entries: number             # ISSUE: → variant_count
total_trials: number
harness: string[]                        # ISSUE: → harness_command
integration_level: string
container_mode: boolean                  # ISSUE: eliminate
image?: string | null
network: string                          # ISSUE: → network_mode
events_path?: string | null
tracing?: string | null                  # ISSUE: → tracing_mode
control_path: string
harness_script_resolved?: string | null
harness_script_exists: boolean           # ISSUE: eliminate (redundant)
```

**`RunResult`** — `types.ts:34`
```ts
run_id: string
run_dir: string
```

**`ExperimentSpec`** — `experiment-builder.ts:19`
```ts
version: '0.3'
experiment: { id, name, description?, owner?, tags? }
dataset: { suite_id, provider, path, schema_version, split_id, limit }
design: { sanitization_profile, comparison, replications, random_seed, shuffle_tasks, max_concurrency }
                                         # ISSUE: replications → repeats
analysis_plan: {
  primary_metrics, secondary_metrics,
  missingness: { policy, record_reasons },
  tests,
  multiple_comparisons: { method },
  reporting: { effect_sizes, show_task_level_table }
}
baseline: { variant_id, bindings }       # ISSUE: bindings should reference parameter manifest
variant_plan: [{ variant_id, bindings }] # ISSUE: same
runtime: {
  harness: { mode, command, integration_level, input_path, output_path,
             control_plane: { mode, path } }
  sandbox: { mode, engine?, image?, root_read_only?, run_as_user?,
             hardening?: { no_new_privileges, drop_all_caps },
             resources?: { cpu_count, memory_mb } }
             # ISSUE: sandbox.mode derivable from image presence
  network: { mode, allowed_hosts }
}
validity: { fail_on_state_leak, fail_on_profile_invariant_violation }
```

### Interfaces — Command Arguments

| Name | Extends | Own fields | File:Line |
|------|---------|-----------|-----------|
| `CommandOptions` | — | `cwd?, env?` | `types.ts:87` |
| `LabClientOptions` | — | `runnerBin?, cwd?, env?` | `types.ts:92` |
| `DescribeArgs` | `CommandOptions` | `experiment, overrides?` | `types.ts:98` |
| `RunArgs` | `DescribeArgs` | `container?` | `types.ts:103` — **ISSUE**: container → image |
| `RunDevArgs` | `DescribeArgs` | `setup?` | `types.ts:107` |
| `RunExperimentArgs` | `DescribeArgs` | — | `types.ts:111` |
| `PublishArgs` | `CommandOptions` | `runDir, out?` | `types.ts:122` |
| `KnobsValidateArgs` | `CommandOptions` | `manifest, overrides` | `types.ts:127` — **ISSUE**: rename |
| `HooksValidateArgs` | `CommandOptions` | `manifest, events` | `types.ts:132` |
| `SchemaValidateArgs` | `CommandOptions` | `schema, file` | `types.ts:137` |

### Interfaces — Builder Options

**`DatasetJsonlOptions`** — `experiment-builder.ts:5`
```ts
suiteId?, provider?, schemaVersion?, splitId?, limit?
```

**`HarnessCliOptions`** — `experiment-builder.ts:13`
```ts
integrationLevel?, inputPath?, outputPath?
```

### Classes

**`LabRunnerError`** — `client.ts:25` (extends `Error`)
```ts
readonly code: string
readonly details?: unknown
readonly exitCode?: number
readonly command: string[]
readonly stderr: string
```

**`LabClient`** — `client.ts:50`
Methods: `describe()`, `run()`, `runDev()`, `runExperiment()`, `publish()`, `validateKnobs()`, `validateHooks()`, `validateSchema()`
Private: `runJson()`, `isErrorEnvelope()`, `spawnCommand()`, `parsePayload()`

**`ExperimentBuilder`** — `experiment-builder.ts:115`
Methods: `create()` (static), `description()`, `owner()`, `tags()`, `datasetJsonl()`, `harnessCli()`, `baseline()`, `addVariant()`, `replications()`, `maxConcurrency()`, `primaryMetrics()`, `secondaryMetrics()`, `networkMode()`, `sandboxImage()`, `localSandbox()`, `build()`, `toYaml()`

---

## 7. CLI Commands (Operations)

| Command | Flags | JSON output? | Maps to SDK method |
|---------|-------|--------------|--------------------|
| `run` | `--experiment, --container, --overrides, --json` | Yes | `client.run()` |
| `run-dev` | `--experiment, --setup, --overrides, --json` | Yes | `client.runDev()` |
| `run-experiment` | `--experiment, --overrides, --json` | Yes | `client.runExperiment()` |
| `describe` | `--experiment, --overrides, --json` | Yes | `client.describe()` |
| `knobs-init` | `--manifest, --overrides, --force` | No | — |
| `knobs-validate` | `--manifest, --overrides, --json` | Yes | `client.validateKnobs()` |
| `schema-validate` | `--schema, --file, --json` | Yes | `client.validateSchema()` |
| `hooks-validate` | `--manifest, --events, --json` | Yes | `client.validateHooks()` |
| `publish` | `--run-dir, --out, --json` | Yes | `client.publish()` |
| `init` | `--in-place, --force` | No | — |
| `clean` | `--init, --runs` | No | — |

---

## 8. CLI JSON Output Fields (the actual wire format)

### Describe response (from `summary_to_json()`)

```json
{
  "ok": true,
  "command": "describe",
  "summary": {
    "experiment": "...",
    "workload_type": "...",
    "dataset": "...",
    "tasks": 10,
    "replications": 3,
    "variant_plan_entries": 2,
    "total_trials": 60,
    "harness": ["node", "..."],
    "integration_level": "...",
    "container_mode": true,
    "image": "...",
    "network": "none",
    "events_path": "...",
    "tracing": "...",
    "control_path": "...",
    "harness_script_resolved": "...",
    "harness_script_exists": true
  }
}
```

**ISSUES** with above: `experiment` → `experiment_id`, `dataset` → `dataset_path`, `tasks` → `task_count`, `replications` → `repeats`, `variant_plan_entries` → `variant_count`, `harness` → `harness_command`, `network` → `network_mode`, `tracing` → `tracing_mode`, eliminate `container_mode` and `harness_script_exists`.

### Run response (ad-hoc in CLI main.rs)

```json
{
  "ok": true,
  "command": "run-dev",
  "summary": { "/* same as describe */" : "" },
  "run": { "run_id": "...", "run_dir": "..." },
  "container": false,
  "dev_setup": "npm ci",
  "dev_network_mode": "full",
  "experiment_network_requirement": "none",
}
```

**ISSUES** with above: eliminate redundant top-level `container`, `dev_setup`, `dev_network_mode`, `experiment_network_requirement` — these duplicate `summary` fields.

---

## 9. Shared Structural Patterns

### The `ids` block
5 fields, identical shape in 6 schemas (see §1).

### The `outcome` / `status` block
```
{ status: enum, error_type?: string, message?: string }
```
Appears in: `event_envelope_v1.outcome`, `hook_events_v1.model_call_end.outcome`, `hook_events_v1.tool_call_end.outcome`

### The `redaction` block (3 variants — **ISSUE**: should be 1)
1. **event_envelope_v1**: `{ applied: bool, mode: "store"|"hash"|"drop" }`
2. **hook_events_v1**: `{ applied: bool, mode: "store"|"hash"|"drop" }`
3. **harness_manifest_v1**: `{ mode: "on"|"off", applied_by_harness: bool, content_policy: "store"|"hash"|"drop" }` — **ISSUE**: `mode` overloaded

### The `artifact_ref` pattern
`artifact://sha256/<hex64>` — used in events, traces, benchmark records, attestation.

### The `sha256_digest` pattern
`sha256:<hex64>` — used for hashchain, resolved_experiment_digest, image_digest, source_digest, exec_digest, lockfile_digest.

### The `error` block
```
{ error_type?: string, message?: string, stack?: string }
```
Appears in: `trial_output_v1.error`, `benchmark_score_record_v1.error`, `hook_events_v1.error_event`

### The `harness_identity` block
```
{ source_digest, exec_digest, entry_command, runtime_fingerprint?, lockfile_digest?, name? }
```
Appears in: `attestation_v1.harness_identity`, `state_inventory_v1.harness_identity`, `harness_manifest_v1.harness`

### The `evaluator` block
```
{ name, version?, mode: "official"|"custom", command? }
```
Appears in: `benchmark_adapter_manifest_v1.evaluator`, `benchmark_score_record_v1.evaluator`

---

## 10. Hook Event Types

All defined in `hook_events_v1` schema as `oneOf` variants extending `base_event`:

| Event Type | Extra Fields | Notes |
|------------|-------------|-------|
| `agent_step_start` | `step_index` (required) | |
| `agent_step_end` | `step_index` (required), `budgets?: { steps, tokens_in, tokens_out, tool_calls }` | |
| `control_ack` | `step_index`, `control_version`, `control_seq?`, `action_observed`, `action_taken?`, `reason?` | |
| `model_call_end` | `call_id`, `turn_index?`, `model?: { identity, params_digest }`, `usage?: { tokens_in, tokens_out }`, `timing?: { queue_wait_ms, duration_ms }`, `attempt_index?`, `outcome` | **ISSUE**: → `model_response`, `call_id` → `turn_id` |
| `tool_call_end` | `call_id`, `tool: { name, version? }`, `timing?`, `attempt_index?`, `outcome` | **ISSUE**: → `tool_result`, `call_id` → `turn_id` |
| `error` | `error_type?`, `message`, `stack?` | |

---

## 11. Analysis Outputs (JSONL tables)

Generated by `lab-analysis` functions, written to `.lab/runs/<run_id>/analysis/tables/`:

| Table file | Key fields |
|------------|-----------|
| `trials.jsonl` | trial_id, variant_id, task_id, repl_idx, outcome, duration_ms, container_mode, ... |
| `metrics_long.jsonl` | trial_id, metric_name, metric_value |
| `event_counts_by_trial.jsonl` | trial_id, event_type, count |
| `event_counts_by_variant.jsonl` | variant_id, event_type, count |
| `variant_summary.jsonl` | variant_id, trial_count, success_count, failure_count, ... |
| `load_duckdb.sql` | DDL to load all tables |

---

## 12. Filesystem Conventions

### Run directory layout
```
.lab/runs/<run_id>/
  manifest.json                    (manifest_v1)
  resolved_experiment.json         (resolved_experiment_v0_3)
  resolved_experiment_digest.txt
  trials/
    <trial_id>/
      trial_input.json             (trial_input_v1)
      trial_output.json            (trial_output_v1)
      workspace/
      state/
      dataset/
      out/
      tmp/
  analysis/
    tables/*.jsonl
    tables/load_duckdb.sql
  attestation.json                 (attestation_v1)
  debug_bundle.tar.gz
```

### Trial paths (from `TrialPaths` struct)
```
trial_dir   → .lab/runs/<run_id>/trials/<trial_id>/
workspace   → trial_dir/workspace
state       → trial_dir/state
dataset     → trial_dir/dataset
out         → trial_dir/out
tmp         → trial_dir/tmp
dataset_src → original dataset file
exp_dir     → project root
```

---

## 13. Design Decisions (from review)

### D1: "Knob" → "Parameter"
Knobs are experiment parameters. Rename everywhere: `knob_manifest_v1` → `parameter_manifest_v1`, `KnobDef` → `ParameterDef`, CLI `knobs-init` → `params-init`, `knobs-validate` → `params-validate`.

### D2: Sandbox mode is derivable — eliminate it
If `image` is set → container mode. If `image` is absent → local mode. No separate `sandbox_mode` / `container_mode` field. CLI `--container` flag → `--image <name>`. `HarnessConfig.force_container` → check image presence.

### D3: `harness_script_exists` is redundant — eliminate it
If `harness_script_resolved` is non-null, it exists. One field, not two.

### D4: "Replications" → "Repeats"
The concept is: for each (variant, task) pair, execute N times. "Replication" collides with "run" and "trial". `repeats` is unambiguous. Field: `design.repeats`, `ExperimentSummary.repeats`, `ExperimentBuilder.repeats()`.

### D5: "Call" → "Turn" (agent loop iteration)
A turn is one iteration of the agent loop (think → act → observe). Within a turn, there are model responses and tool results. Hook event renames: `model_call_end` → `model_response`, `tool_call_end` → `tool_result`, `call_id` → `turn_id`. `turn_index` stays as-is (sequence within step).

### D6: Variant bindings must be validated against parameter manifest
Variant `bindings` should reference parameter IDs defined in the parameter manifest. The system validates types, ranges, and allowed values. The SDK `ExperimentBuilder` auto-generates the parameter manifest from `.baseline()` and `.addVariant()` calls. This enables: variant diffing, treatment vs control tracking, analysis by parameter value.

### D7: Redaction block should be consistent
`harness_manifest_v1` uses `redaction.mode: "on"|"off"` + `redaction.content_policy`. Everything else uses `redaction.mode: "store"|"hash"|"drop"`. Align harness manifest: `redaction.enabled: bool` + `redaction.content_policy: "store"|"hash"|"drop"`.

### D8: Tracing mode enum should be consistent
`harness_manifest_v1` is missing `"hooks"` from its tracing mode enum that `attestation_v1` has. Add it: `["none", "hooks", "otlp", "manifest"]`.

### D9: Attestation field names must match schema
Rust `default_attestation()` emits field names that don't match `attestation_v1.jsonschema`:
- `events_hashchain_heads` → `events_hashchain`
- `grades` → `grades_summary`
- `harness` → `harness_identity`
- `trace_ingestion` as bare string → emit as object `{ mode, artifact_ref }`

### D10: `build_trial_input()` run_id bug
Currently sets `ids.run_id` to the experiment_id, not the actual run_id. Fix: pass actual `run_id` into the function.

### D11: Remove `/variants` fallback in `resolve_variant_plan()`
Removed: `variants` is no longer accepted as a fallback for `/variant_plan`.

### D12: Field name alignment across surfaces
The describe summary fields must use the same names in Rust struct, CLI JSON output, and SDK type. Canonical names (Rust struct is source of truth, CLI JSON and SDK mirror it):
- `experiment_id` (not `exp_id`, not `"experiment"`)
- `dataset_path` (not `"dataset"`)
- `task_count` (not `"tasks"`)
- `repeats` (not `"replications"`)
- `variant_count` (not `"variant_plan_entries"`)
- `harness_command` (not `"harness"`)
- `network_mode` (not `"network"`)
- `tracing_mode` (not `"tracing"`)
- Eliminate: `container_mode`, `harness_script_exists`

### D13: Run response cleanup
Remove redundant top-level fields from run response: `container`, `dev_network_mode`, `experiment_network_requirement`, `dev_setup`. These duplicate information already in `summary`.
