{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agent-lab.local/schemas/hook_events_v1.json",
  "title": "Hook Events v1 (per-line schema)",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/agent_step_start" },
    { "$ref": "#/$defs/agent_step_end" },
    { "$ref": "#/$defs/control_ack" },
    { "$ref": "#/$defs/model_call_end" },
    { "$ref": "#/$defs/tool_call_end" },
    { "$ref": "#/$defs/error_event" }
  ],
  "$defs": {
    "base_event": {
      "type": "object",
      "additionalProperties": true,
      "required": ["event_type", "ts", "seq", "ids"],
      "properties": {
        "hooks_schema_version": { "const": "hook_events_v1" },
        "event_type": { "type": "string", "minLength": 1 },
        "ts": { "type": "string", "format": "date-time" },
        "seq": { "type": "integer", "minimum": 0 },
        "ids": {
          "type": "object",
          "additionalProperties": false,
          "required": ["run_id", "trial_id", "variant_id", "task_id", "repl_idx"],
          "properties": {
            "run_id": { "type": "string", "minLength": 1 },
            "trial_id": { "type": "string", "minLength": 1 },
            "variant_id": { "type": "string", "minLength": 1 },
            "task_id": { "type": "string", "minLength": 1 },
            "repl_idx": { "type": "integer", "minimum": 0 }
          }
        },
        "step_index": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "If steps are supported, associate this event to a step."
        },
        "payload_ref": {
          "type": "string",
          "pattern": "^artifact://sha256/[0-9a-f]{64}$"
        },
        "redaction": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "applied": { "type": "boolean" },
            "mode": { "type": "string", "enum": ["store", "hash", "drop"] }
          }
        },
        "ext": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "agent_step_start": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "step_index"],
          "properties": {
            "event_type": { "const": "agent_step_start" },
            "step_index": { "type": "integer", "minimum": 0 }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "agent_step_end": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "step_index"],
          "properties": {
            "event_type": { "const": "agent_step_end" },
            "step_index": { "type": "integer", "minimum": 0 },
            "budgets": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "steps": { "type": "integer", "minimum": 0 },
                "tokens_in": { "type": "integer", "minimum": 0 },
                "tokens_out": { "type": "integer", "minimum": 0 },
                "tool_calls": { "type": "integer", "minimum": 0 }
              }
            }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "control_ack": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "step_index", "control_version", "action_observed"],
          "properties": {
            "event_type": { "const": "control_ack" },
            "step_index": { "type": "integer", "minimum": 0 },
            "control_version": {
              "type": "string",
              "pattern": "^sha256:[0-9a-f]{64}$"
            },
            "control_seq": { "type": "integer", "minimum": 0 },
            "action_observed": {
              "type": "string",
              "enum": ["continue", "stop", "checkpoint"]
            },
            "action_taken": {
              "type": "string",
              "enum": ["continue", "stop", "checkpoint"]
            },
            "reason": { "type": "string" }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "model_call_end": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "call_id", "outcome"],
          "properties": {
            "event_type": { "const": "model_call_end" },
            "call_id": { "type": "string", "minLength": 1 },
            "turn_index": { "type": "integer", "minimum": 0 },
            "model": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "identity": { "type": "string", "minLength": 1 },
                "params_digest": { "type": "string", "pattern": "^sha256:[0-9a-f]{64}$" }
              }
            },
            "usage": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "tokens_in": { "type": "integer", "minimum": 0 },
                "tokens_out": { "type": "integer", "minimum": 0 }
              }
            },
            "timing": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "queue_wait_ms": { "type": "integer", "minimum": 0 },
                "duration_ms": { "type": "integer", "minimum": 0 }
              }
            },
            "attempt_index": { "type": "integer", "minimum": 0 },
            "outcome": {
              "type": "object",
              "additionalProperties": false,
              "required": ["status"],
              "properties": {
                "status": { "type": "string", "enum": ["ok", "error"] },
                "error_type": { "type": "string" },
                "message": { "type": "string" }
              }
            }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "tool_call_end": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "call_id", "tool", "outcome"],
          "properties": {
            "event_type": { "const": "tool_call_end" },
            "call_id": { "type": "string", "minLength": 1 },
            "tool": {
              "type": "object",
              "additionalProperties": false,
              "required": ["name"],
              "properties": {
                "name": { "type": "string", "minLength": 1 },
                "version": { "type": "string" }
              }
            },
            "timing": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "queue_wait_ms": { "type": "integer", "minimum": 0 },
                "duration_ms": { "type": "integer", "minimum": 0 }
              }
            },
            "attempt_index": { "type": "integer", "minimum": 0 },
            "outcome": {
              "type": "object",
              "additionalProperties": false,
              "required": ["status"],
              "properties": {
                "status": { "type": "string", "enum": ["ok", "error"] },
                "error_type": { "type": "string" },
                "message": { "type": "string" }
              }
            }
          }
        }
      ],
      "unevaluatedProperties": false
    },
    "error_event": {
      "allOf": [
        { "$ref": "#/$defs/base_event" },
        {
          "type": "object",
          "required": ["event_type", "message"],
          "properties": {
            "event_type": { "const": "error" },
            "error_type": { "type": "string" },
            "message": { "type": "string", "minLength": 1 },
            "stack": { "type": "string" }
          }
        }
      ],
      "unevaluatedProperties": false
    }
  }
}
